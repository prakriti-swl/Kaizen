{% extends "base.html" %}
{% load static %}

{% block content %}

<section class="about-hero" style="background-image: url({% static 'img/background-img1.jpg' %});">
  <h2> Product Details </h2>
  <p>Know more about our products and their benefits.</p>
</section>

<section class="product-detail">
  <div class="container">

    <a href="{% url 'products' %}" class="btn btn-outline-secondary"
       style="position: absolute; top: 20px; right: 20px;">
      &larr; Back to Products
    </a>

    <!-- PRODUCT TOP (IMAGE + DETAILS) -->
    <div class="product-detail-container">

      <!-- LEFT -->
      <div class="product-detail-image">
        <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-image img-fluid">
      </div>

      <!-- RIGHT -->
      <div class="product-info-detail">
        <h2 class="product-detail-name">{{ product.name }}</h2>

        <div class="stars">
          {% for i in "12345" %}
            {% if forloop.counter <= product.average_rating %}
              â˜…
            {% else %}
              â˜†
            {% endif %}
          {% endfor %}
          <span>({{ product.reviews.count }} reviews)</span>
        </div>

        <div class="price-box">
          {% if product.sale_price %}
            <span class="original-price">${{ product.price }}</span>
            <span class="sale-price">${{ product.sale_price }}</span>
          {% else %}
            <span class="sale-price">${{ product.price }}</span>
          {% endif %}
        </div>

        <p class="description">
          {{ product.description|linebreaksbr }}
        </p>

        <div class="detail-cart-concern">
          <div class="cart-button d-flex justify-content-between align-items-center">
            <a href="#" class="btn-wrap cart-link d-flex align-items-center text-capitalize fs-6">ðŸ›’</a>
            <a href="#" class="wishlist-btn mt-1">
              <i class="icon icon-heart"></i>
            </a>
          </div>
      </div>
      </div>
    </div>

    {% comment %} <div class="review-section">

      <h3>Customer Reviews</h3>

      {% for review in product.reviews.all %}
      <div class="review">
        <img src="{% static 'images/user.png' %}" class="review-avatar">
        <div class="review-content">
          <div class="review-header">
            <strong>{{ review.user.username }}</strong>
            <span class="stars">
              {% for i in "12345" %}
                {% if forloop.counter <= review.rating %}
                  â˜…
                {% else %}
                  â˜†
                {% endif %}
              {% endfor %}
            </span>
          </div>
          <p>{{ review.comment }}</p>
          <small>{{ review.created_at|date:"M d, Y" }}</small>
        </div>
      </div>
      {% empty %}
        <p>No reviews yet.</p>
      {% endfor %}

      {% if user.is_authenticated %}
      <div class="write-review">
        <h4>Write a Review</h4>

        <!-- Write Review Button -->
        <button type="button"
                class="btn btn-outline-primary"
                id="writeReviewBtn"
                onclick="toggleReviewForm()">
          Write a Review
        </button>

        <!-- Review Form -->
        <form method="POST" id="reviewForm" style="display:none;">
  
          <!-- ðŸ”¹ NEW CLOSE BUTTON (INSIDE FORM) -->
          <button type="button"
                  class="review-close-btn"
                  onclick="toggleReviewForm()">
            âœ•
          </button>

          {% csrf_token %}

          <div class="star-rating">
              {% for i in "54321" %}
              <input type="radio" name="rating" value="{{ i }}" id="star{{ i }}">
              <label for="star{{ i }}">â˜…</label>
              {% endfor %}
          </div>

          <textarea name="comment" placeholder="Write your review..." required></textarea>

          <div class="form-submit">
            <button type="submit" class="btn">Send</button>
          </div>
        </form>

      </div>
      {% endif %}
    </div> {% endcomment %}

  </div>
</section>

<div class="card reviews-card">

    <h3>Reviews</h3>

    {% if user.is_authenticated %}
    <form method="POST" action="{% url 'submit_review' product.id %}" class="review-form">
        {% csrf_token %}

        <div class="star-rating">
            {% for i in "54321" %}
            <input type="radio" name="rating" value="{{ i }}" id="star{{ i }}">
            <label for="star{{ i }}">â˜…</label>
            {% endfor %}
        </div>

        <textarea name="comment" placeholder="Write your review..." required></textarea>
        <div class="form-submit">
          <button type="submit" class="btn">Send Review</button>
        </div>
    </form>
    {% else %}
    <p><a href="{% url 'login' %}">Login</a> to write a review.</p>
    {% endif %}

    <hr>

    <!-- REVIEWS LIST -->
    <div id="review-list">
        {% for review in reviews %}
        <div class="review-item">
            <img src="{{ review.user.image.url }}">
            <div>
                <strong>{{ review.user.username }}</strong>
                <div class="stars">
                    {% for i in "12345" %}
                        {% if forloop.counter <= review.rating %}â˜…{% else %}â˜†{% endif %}
                    {% endfor %}
                </div>
                <p>{{ review.message }}</p>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if total_reviews > 5 %}
    <button
        id="load-more"
        class="btn outline full"
        data-url="{% url 'load_more_reviews' product.id %}"
        data-offset="5"
    >
        See more
    </button>    
    {% endif %}
</div>


{% endblock content %}
